<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8" />
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500&display=swap" rel="stylesheet" />
        <style>
            body {
                font-family: "Poppins", sans-serif;
            }

            .center {
                margin: auto;
                width: 60%;
                text-align: center;
                padding: 10px;
            }

            img {
                display: block;
                margin-left: auto;
                margin-right: auto;
                width: 30%;
            }

            video {
                display: block;
                margin-left: auto;
                margin-right: auto;
                width: 30%;
                transform: translate(0px, -100%);
            }
        </style>
        <title>Caffeinated Donations</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.8/socket.io.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/2.0.2/anime.min.js"></script>
        <script src="overlayutil.js"></script>
    </head>

    <body>
        <h1 class="center" id="event" style="opacity: 0;">
            <img class="image" src="" id="image" />
            <video class="image" src="" id="video"></video>
            <div class="text-container">
                <span id="user"></span>
                <br />
                <span id="text"></span>
            </div>
        </h1>
    </body>

    <footer>
        <script>
            const overlay = new OverlayUtil("casterlabs_donation");
            const DISPLAY_TIME = 10 * 1000;
            const FADE_TIME = 1000;
            const video = document.querySelector("#video");
            const user = document.querySelector("#user");
            const img = document.querySelector("#image");
            const text = document.querySelector("#text");
            let config = null;
            let files = {};
            let audio = {};
            let queue = [];

            overlay.on("config", (data) => {
                config = data;

                audio.volume = config.volume;
                updateRenderer();
            });

            overlay.on("audio_file", (data) => {
                files.audio_file = data;
            });

            overlay.on("image_file", (data) => {
                files.image_file = data;
            });

            overlay.on("event", (event) => {
                if (config) {
                    queue.push(event);

                    if (queue.length == 1) {
                        render();
                    }
                }
            });

            function updateRenderer() {
                let text = document.querySelector("#text");

                text.style = "color: " + config.text_color + ";";
            }

            async function render() {
                let event = queue[0];

                if (config.use_custom_image) {
                    if (files.image_file) {
                        if (files.image_file.startsWith("data:video")) {
                            video.src = files.image_file;
                            img.src = "data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";
                            video.play();
                        } else {
                            img.src = files.image_file;
                            video.src = "";
                        }
                    } else {
                        img.src = "data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";
                    }
                } else {
                    img.src = event.image;
                }

                text.innerText = event.message;

                user.innerText = event.sender.username;
                user.style = "color: " + event.sender.color + ";";

                if (config.enable_audio) {
                    playAudio();
                }

                anime({
                    targets: "#event",
                    easing: "linear",
                    opacity: 1,
                    duration: FADE_TIME
                }).finished.then(async function () {
                    await sleep(DISPLAY_TIME);

                    anime({
                        targets: "#event",
                        easing: "linear",
                        opacity: 0,
                        duration: FADE_TIME
                    }).finished.then(function () {
                        queue.shift();

                        if (queue.length > 0) {
                            render();
                        }
                    });
                });
            }

            function playAudio() {
                try {
                    audio = new Audio(files.audio_file);

                    audio.volume = config.volume;
                    audio.play();
                } catch (e) {
                    audio = {};
                }
            }

            function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

        </script>
    </footer>

</html>