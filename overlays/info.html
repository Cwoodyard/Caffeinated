<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8" />
        <title>Caffeinated TopDonation</title>
        <link id="font" rel="stylesheet" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.8/socket.io.min.js"></script>
        <script>
            let vars = {};

            window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (m, key, value) {
                vars[key] = value;
            });
        </script>
    </head>

    <body>
        <span id="user"></span>
        <span id="amount"></span>
    </body>

    <footer>
        <script>
            const namespace = "casterlabs_info:" + vars["id"];
            const socket = io("http://localhost:8091", {
                "reconnection": true,
                "reconnectionDelay": 2000,
                "reconnectionAttempts": Number.MAX_SAFE_INTEGER
            });
            let config = null;

            document.querySelector("#font").href = vars["font"];

            socket.on("init", () => {
                socket.emit("uuid", namespace);
            });

            socket.on(namespace + " config", (data) => {
                config = data;

                document.querySelector("#user").style = "color: " + config.text_color + ";";
                document.querySelector("#amount").style = "color: " + config.text_color + ";";
            });

            socket.on(namespace + " event", (event) => {
                if (config) {
                    let amount = document.querySelector("#amount");
                    let user = document.querySelector("#user");

                    if (event) {
                        if (event.hasOwnProperty("follower")) {
                            user.innerText = event.follower.username;
                            amount.innerText = "";
                        } else {
                            user.innerText = event.sender.username;

                            if (config.currency == "usd") {
                                let round = (Math.round(event.usd_equivalent * 100) / 100).toFixed(2);

                                amount.innerText = "$" + round;
                            } else {
                                amount.innerText = event.formatted;
                            }
                        }
                    } else {
                        user.innerText = "";
                        amount.innerText = "";
                    }
                }
            });

        </script>
    </footer>

</html>