<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Caffeinated</title>
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.13.0/css/all.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js" type="text/javascript"></script>
  </head>
  <body>
    <div id="splash" class="centered">
      <img src="media/caf.png" id="logo">
      <img src="media/load4.gif" id="load">
    </div>
    <div id="content" class="hide">
      <div class="header">
        <label class="title">Caffeinated</label>
        <i id="closebtn" class="fas fa-times"></i>
        <!-- <img id="loading" class="hide" src="media/load2.gif"> -->
      </div>

      <div class="sidenav">
        <a href="#sub1" style="cursor: default;"><img id="menuAvatar" class="userIcon" src="media/icon.png"/></a>
        <div id="followersTitle" style="color:white; font-size: 12px; padding-top: 10px;"></div>
        <div id="followerCount" style="color:white; font-size: 14px; padding-top: 5px;"></div>
        <a href="#sub3"><i id="menuGoal" class="fas fa-hand-holding-usd menuIcon sideNavItem"></i></a>
        <a href="#sub2"><i id="menuSettings" class="fas fa-sliders-h menuIcon sideNavItem"></i></a>
      </div>

      <div class="main">
        <div id="sub1" class="sub">
            <h3 id="greetings" style="margin-top: 0;">Set user in settings</h3>
            <div class="container" style="padding-top: 0;">
              <div style="white-space: nowrap;"><label class="container-title"><input type="checkbox" id="enableAlertFollowers" onclick="checkBox('enableAlertFollowers')">Follower alert</label></div>
              <div><input onclick="clipboard('followers')" type="button" class="button" value="Copy"></div>  
              <div style="margin: 0 -50px 0 -60px;"><input id="testFollower" type="button" class="button" value="Test"></div>
            </div>
            <div class="container">
              <div style="white-space: nowrap;"><label class="container-title"><input type="checkbox" id="enableAlertDonations" onclick="checkBox('enableAlertDonations')">Donations alert</label></div>
              <div><input onclick="clipboard('donations')" type="button" class="button" value="Copy"></div>  
              <div style="margin: 0 -50px 0 -60px;"><input id="testDonation" type="button" class="button" value="Test"></div>
            </div>
            <div class="container">
              <div style="white-space: nowrap;"><label class="container-title"><input type="checkbox" id="enableChat" onclick="checkBox('enableChat')">Chat</label></div>
              <div><input onclick="clipboard('chat')" type="button" class="button" value="Copy"></div>  
              <div style="margin: 0 -50px 0 -60px;"><input id="testChat" type="button" class="button" value="Test"></div>
            </div>
            <div class="container">
              <div style="white-space: nowrap;"><label class="container-title"><input type="checkbox" id="enableGoal" onclick="checkBox('enableGoal')">Donation goal</label></div>
              <div><input onclick="clipboard('goal')" type="button" class="button" value="Copy"></div>  
              <div style="margin: 0 -50px 0 -60px;"><a href="#sub3"><input id="settingsGoal" type="button" class="button" value="Settings"></a></div>
            </div>
            <!-- <div class="container">
              <div style="white-space: nowrap;"><label class="container-title"><input type="checkbox" id="enableTopDon" onclick="checkBox('enableTopDon')">Top donators</label></div>
              <div><input onclick="clipboard('top-donators')" type="button" class="button" value="Copy"></div>  
              <div style="margin: 0 -50px 0 -60px;"><a href="#sub3"><input id="settingsGoal" type="button" class="button" value="Settings"></a></div>
            </div> -->
          <div class="lowerButtonContainer">
            <!-- <div class="lowerButton" id="openOverlay">
              OPEN OVERLAY
            </div>
            <div class="lowerButton" id="toggleBackground">
              TOGGLE BACKGROUND
            </div> -->
            <input id="openOverlay" type="button" class="button" style="width: 50%; margin-left:10px;" value="Open overlay">
            <input id="toggleBackground" type="button" class="button" style="width: 50%; margin-left:15px;" value="Toggle background">
          </div>
        </div>

        <div id="sub2" class="hide sub">
          <h4 style="margin-bottom: -5px;">General settings</h4>
          <div class="menuItemDiv" style="margin-bottom: -10px;"><input type="text" id="setUserInput" placeholder="Username" style="width: 228px;"><input id="setUser" type="button" class="button" value="Apply" style="margin-left: 10px;"></div>
          <div class="menuItemDiv">Localhost port<input type="text" id="setPort" style="width: 70px;float:right; margin:-7px 20px;"></div>
          <hr>
          <h4 style="margin-bottom: -5px;">Follower alert</h4>
          <div class="menuItemDiv">Timeout (seconds)<input type="text" id="setTimeoutFollowers" style="width: 70px;float:right; margin:-7px 20px;"></div>
          <div class="menuItemDiv">Username color<input type="color" id="setFollowerColor" style="width: 68px;float:right; margin:-7px 20px; border:0;"></div>
          <div class="menuItemDiv">Show GIF<input type="checkbox" id="showGIFFollower" onclick="checkBox('showGIFFollower')" style="width: 40px;float:right; margin:0 35px;"></div>
          <div class="menuItemDiv">Select GIF<div onclick="selectFile('FOLLOWER_GIF')" style="width: 68px;float:right; margin:-1px 27px;"><input id="setUser" type="button" class="button" value="Select"></div></div>
          <div class="menuItemDiv">Play audio<input type="checkbox" id="playAudioFollower" onclick="checkBox('playAudioFollower')" style="width: 40px;float:right; margin:0 35px;"></div>
          <div class="menuItemDiv">Select MP3<div onclick="selectFile('FOLLOWER_MP3')" style="width: 68px;float:right; margin:-1px 27px;"><input id="setUser" type="button" class="button" value="Select"></div></div>
          <hr>
          <h4 style="margin-bottom: -5px;">Donation alert</h4>
          <div class="menuItemDiv">Timeout (seconds)<input type="text" id="setTimeoutDonations" style="width: 70px;float:right; margin:-7px 20px;"></div>
          <div class="menuItemDiv">Username color<input type="color" id="setDonationColor" style="width: 68px;float:right; margin:-7px 20px; border:0;"></div>
          <div class="menuItemDiv">Show GIF<input type="checkbox" id="showGIFDonation" onclick="checkBox('showGIFDonation')" style="width: 40px;float:right; margin:0 35px;"></div>
          <div class="menuItemDiv">Select GIF<div onclick="selectFile('DONATION_GIF')" style="width: 68px;float:right; margin:-1px 27px;"><input id="setUser" type="button" class="button" value="Select"></div></div>
          <div class="menuItemDiv">Play audio<input type="checkbox" id="playAudioDonation" onclick="checkBox('playAudioDonation')" style="width: 40px;float:right; margin:0 35px;"></div>
          <div class="menuItemDiv">Select MP3<div onclick="selectFile('DONATION_MP3')" style="width: 68px;float:right; margin:-1px 27px;"><input id="setUser" type="button" class="button" value="Select"></div></div>
          <hr>
          <h4 style="margin-bottom: -5px;">Chat</h4>
          <div class="menuItemDiv">Max. chat items <input type="text" id="setChatMax" style="width: 70px;float:right; margin:-7px 20px;"></div> 
          <div class="menuItemDiv">Chat color <input type="color" id="setChatTextColor" style="width: 68px;float:right; margin:-7px 20px; border:0;"></div>
        </div>

        <div id="sub3" class="hide sub">
          <h4 style="margin-bottom: -5px;">Donation goal</h4>
          <div class="menuItemDiv"><input type="text" id="setGoalTitle" placeholder="Goal title" style="width: 92%;"></div>
          <div class="menuItemDiv">Goal type
            <select id="goalTypes" style="float:right; margin:-3px 27px;">
              <option value="percentage">Percentage (0-100%)</option>
              <option value="usd">USD</option>
              <!-- <option value="gold">Gold (cost of prop)</option> -->
              <!-- <option value="credits">Credits (actual prop worth)</option> -->
            </select>
          </div>
          <div class="menuItemDiv">Goal reached (USD)<input type="text" id="goalReached" style="width: 70px;float:right; margin:-7px 20px;"></div>
          <div class="menuItemDiv">Goal amount (USD)<input type="text" id="goalUSD" style="width: 70px;float:right; margin:-7px 20px;"></div>
          <div class="menuItemDiv">Goal amount (Credits)<input type="text" id="goalCredits" style="width: 70px;float:right; margin:-7px 20px;"></div>
          <div class="menuItemDiv">Goal amount (Gold)<input type="text" id="goalGold" style="width: 70px;float:right; margin:-7px 20px;"></div> 
          <div class="menuItemDiv">Note: these numbers are based on direct calculations between USD and credit ratio assuming $100 = 10050 credits. Caffeinated has to be open as it is logging all the incomming donations.</div>
          <div class="menuItemDiv">Bar color<input type="color" id="setGoalBarColor" style="width: 68px;float:right; margin:-7px 20px; border:0;"></div>
          <div class="menuItemDiv">Text color<input type="color" id="setGoalTextColor" style="width: 68px;float:right; margin:-7px 20px; border:0;"></div>
          <hr>
          <h4 style="margin-bottom: -5px;">Donations</h4>
          <div class="menuItemDiv">
            <div class="tableFixHead">
              <p id="donatorTable"></p>
            </div>
          </div>
          <!-- <div class="menuItemDiv">Top donator count in overlay<input type="text" id="donUserCount" style="width: 70px;float:right; margin:-7px 20px;"></div> -->         
        </div>
      </div>
    </div>
    <!-- <script src="testingGround.js"></script> -->
    <script>
      // var followerLink = "http://127.0.0.1:5000/followers/";
      // var usersLink = "http://127.0.0.1:5000/users/";
      var followerLink = "https://caffeinated-api.herokuapp.com/followers/";
      var usersLink = "https://caffeinated-api.herokuapp.com/users/";
      /* General include */
      const electron = require('electron').remote
      const dialog = electron.dialog
      const Store = require('electron-store');
      const {ipcMain, BrowserWindow} = require('electron').remote
      // const {dialog} = require('electron');
      const store = new Store();
      const toggleBackground = document.getElementById('toggleBackground');
      
      /* Sockets IO */
      var express = require('express');
      var cors = require('cors')
      var app = express();
      var server = require('http').createServer(app);
      var io = require('socket.io').listen(server);

      app.use(cors());

      server.listen(store.get("hostPort"), "localhost");
      console.log("Server running on port " + String(store.get("hostPort")));

      app.get('/', function(req,res){
        res.send("pong");
      });

      app.get('/chat', function(req,res){
        res.sendFile(__dirname+"/chat.html");
      });

      app.get('/followers', function(req,res){
        res.sendFile(__dirname+"/followers.html");
      });

      app.get('/donations', function(req,res){
        res.sendFile(__dirname+"/donations.html");
      });

      app.get('/goal', function(req,res){
        res.sendFile(__dirname+"/goal.html");
      });

      app.get('/top-donators', function(req,res){
        res.sendFile(__dirname+"/top-donators.html");
      });

      app.get('/media/follower-alert.mp3',function(req,res){
        res.sendFile(store.get('followerAudio')); 
      });

      app.get('/media/follower-gif.gif',function(req,res){
        res.sendFile(store.get('followerGIF')); 
      });

      app.get('/media/donation-alert.mp3',function(req,res){
        res.sendFile(store.get('donationAudio')); 
      });

      app.get('/media/donation-gif.gif',function(req,res){
        res.sendFile(store.get('donationGIF')); 
      });

      io.sockets.on('connection', function(socket){
        console.log("New connection");
        io.sockets.emit('change chat color', store.get("chatTextColor"));
        io.sockets.emit('change follower color', store.get("followerColor"));
        io.sockets.emit('change donation color', store.get("donationColor"));
        io.sockets.emit('change goal title', store.get("goalTitle"));
        io.sockets.emit('change goal text color', store.get("goalTitleColor"));
        io.sockets.emit('change goal bar color', store.get("goalBarColor"));
        var ioData = {total:store.get('goal'), current:store.get('goalReached'), type:store.get('goalType')};
        io.sockets.emit('goal', ioData);
        
        
        //Disconect
        socket.on('disconnect', function(data){

        });

        socket.on('play audio', function(data){
          var audio;
          if(data === "follower") {
            audio = new Audio(store.get('followerAudio'));
            if(store.get("playAudioFollower")){audio.play();}
          }
          if(data === "donation") {
            audio = new Audio(store.get('donationAudio'));
            if(store.get("playAudioDonation")){audio.play();}
          }
        });
      });
      
      document.getElementById("goalUSD").addEventListener("input", (event) => {
        var usd = document.getElementById("goalUSD").value;
        var credits = Math.round((usd / 0.00995024875)*100)/100;
        var gold = Math.round((credits / 3)*100)/100;
        
        document.getElementById("goalGold").value = gold;
        document.getElementById("goalCredits").value = credits;

        store.set("goal", parseFloat(usd));
        var ioData = {total:store.get('goal'), current:store.get('goalReached'), type:store.get('goalType')};
        io.sockets.emit('goal', ioData);
      });

      document.getElementById("goalCredits").addEventListener("input", (event) => {
        var credits = document.getElementById("goalCredits").value;
        var usd = Math.round((credits * 0.00995024875)*100)/100;
        var gold = Math.round((credits / 3)*100)/100;

        document.getElementById("goalGold").value = gold;
        document.getElementById("goalUSD").value = usd;

        store.set("goal", parseFloat(usd));
        var ioData = {total:store.get('goal'), current:store.get('goalReached'), type:store.get('goalType')};
        io.sockets.emit('goal', ioData);
      });

      document.getElementById("goalGold").addEventListener("input", (event) => {
        var gold = document.getElementById("goalGold").value;
        var credits = Math.round((gold * 3)*100)/100;
        var usd = Math.round((credits * 0.00995024875)*100)/100;

        document.getElementById("goalUSD").value = usd;
        document.getElementById("goalCredits").value = credits;

        store.set("goal", parseFloat(usd));
        var ioData = {total:store.get('goal'), current:store.get('goalReached'), type:store.get('goalType')};
        io.sockets.emit('goal', ioData);
      });

      toggleBackground.addEventListener('click', (event) => {
        io.sockets.emit('toggle background', 1);
      });

      const openOverlay = document.getElementById('openOverlay');

      openOverlay.addEventListener('click', (event) => {
        setTimeout(function(){
          io.sockets.emit('toggle background', 1);
          io.sockets.emit('set overlay title', 1);
        },1000);
        if(store.get("enableAlertFollowers")) {
          let win = new BrowserWindow({ 
            width: 300,
            height: 300,
            transparent: true,
            resizable: false,
            frame: false,
            alwaysOnTop: true,
            setVisibleOnAllWorkspaces:true
          });

          win.on('close', () => { win = null });
          win.loadURL("http://127.0.0.1:8080/followers");
          win.setAlwaysOnTop(true, "floating", 1);
          win.setVisibleOnAllWorkspaces(true);
          win.show();
        }

        if(store.get("enableAlertDonations")) {
          let win = new BrowserWindow({ 
            width: 300,
            height: 300,
            transparent: true,
            resizable: false,
            frame: false,
            alwaysOnTop: true
          });

          win.on('close', () => { win = null });
          win.loadURL("http://127.0.0.1:8080/donations");
          win.setAlwaysOnTop(true, "floating", 1);
          win.setVisibleOnAllWorkspaces(true);
          win.show();
        }

        if(store.get("enableChat")) {
          var chatHeight = parseInt(store.get("maxChat"))*35;
          let win = new BrowserWindow({ 
            width: 900,
            height: chatHeight,
            transparent: true,
            resizable: false,
            frame: false,
            alwaysOnTop: true
          });

          win.on('close', () => { win = null });
          win.loadURL("http://127.0.0.1:8080/chat");
          win.setAlwaysOnTop(true, "floating", 1);
          win.setVisibleOnAllWorkspaces(true);
          win.show();
        }

        if(store.get("enableGoal")) {
          let win = new BrowserWindow({ 
            width: 900,
            height: 100,
            transparent: true,
            resizable: false,
            frame: false,
            alwaysOnTop: true
          });

          win.on('close', () => { win = null });
          win.loadURL("http://127.0.0.1:8080/goal");
          win.setAlwaysOnTop(true, "floating", 1);
          win.setVisibleOnAllWorkspaces(true);
          win.show();
        }
                
      })


      function selectFile(type) {
        var filePath; 
        dialog.showOpenDialog({ properties: ['openFile']}).then(result => {
          console.log(result.canceled);
          if (!result.canceled) { 
            filePath = result.filePaths;
            filePath = filePath[0];
            switch(type){
              case "FOLLOWER_GIF":
                store.set('followerGIF', filePath);
                io.sockets.emit('reload', 1);
                break;
              case "FOLLOWER_MP3":
                store.set('followerAudio', filePath);
                break;
              case "DONATION_GIF":
                store.set('donationGIF', filePath);
                io.sockets.emit('reload', 1);
                break;
              case "DONATION_MP3":
                store.set('donationAudio', filePath);
                break;
            }
          } 
        }).catch(err => {
          console.log(err);
        });
      }

      function mergeJson(o1, o2) {
        var tempNewObj = o1;

        //if o1 is an object - {}
        if (o1.length === undefined && typeof o1 !== "number") {
          $.each(o2, function(key, value) {
            if (o1[key] === undefined) {
              tempNewObj[key] = value;
            } else {
              tempNewObj[key] = mergeJson(o1[key], o2[key]);
            }
          });
        }

        //else if o1 is an array - []
        else if (o1.length > 0 && typeof o1 !== "string") {
          $.each(o2, function(index) {
            if (JSON.stringify(o1).indexOf(JSON.stringify(o2[index])) === -1) {
              tempNewObj.push(o2[index]);
            }
          });
        }

        //handling other types like string or number
        else {
          //taking value from the second object o2
          //could be modified to keep o1 value with tempNewObj = o1;
          tempNewObj = o2;
        }
        return tempNewObj;
      };

      function donatorTableUpdate() {
        /* Generate donator table */
        var donatorList = store.get("donatorList");
        var user = store.get("user");
        txt = "<table><thead><tr><th>User</th><th>Credits</th><th>USD</th></tr></thead><tbody>";
        for (var key in donatorList[user]) {
            // console.log("Key: " + key);
            // console.log("Value: " + obj.d[key]);
            txt += "<tr><td>" + key + "</td><td>" + donatorList[user][key] + "</td><td>" + Math.round((donatorList[user][key] * 0.00995024875)*100)/100 + "</td></tr>";
        }
        txt += "</tbody></table>";
        document.getElementById("donatorTable").innerHTML = txt;
      }

      /* Get user info and start up listeners */
      var userSaved = store.get('user');
			if(userSaved !== undefined)
			{
        var link = usersLink + userSaved;
			
        var json = new XMLHttpRequest();
        json.open("GET", link, false); 
        json.send(null);
      
        var userInfo = JSON.parse(json.response);
        userInfo = userInfo.user;
        var username = userInfo.username;

        donatorTableUpdate();

        connectChatDon(userInfo.stage_id);

        // SITAS LAGO!
        setInterval( function getFollowers(){
          var xmlHttp = new XMLHttpRequest();
          xmlHttp.open("GET", followerLink + store.get("user"), true);
          xmlHttp.onreadystatechange = function() {
            if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
              var followerList = JSON.parse(xmlHttp.responseText);
              for(var i = followerList.followers.length-1; i >= 0; i--) {
                var followedTime = followerList.followers[i].followed_at;
                var caid = followerList.followers[i].caid;
                var oldFollowers = JSON.stringify(store.get("followerListFull"));
                if(followedTime > store.get("lastFollower") && oldFollowers.search(String(caid)) === -1) {
                  store.set("lastFollower", followedTime);
                  followedUsername = JSON.parse(httpGet(usersLink + caid));
                  followedUsername = followedUsername.user.username;
                  console.log(followedUsername + " followed you!");
                  var ioData = {'username':followedUsername, 'text': 'just followed', 'gif':store.get("showGIFFollower"), 'timeout':store.get("timeoutFollowers")};
                  var followText = store.get("followText");
                  if(followText !== undefined && followText.length > 1) {
                    ioData.text = followText;
                  }
                  if(store.get("enableAlertFollowers")){io.sockets.emit('follower alert', ioData);}
                  store.set("followerListFull", mergeJson(store.get("followerListFull"), followerList));
                }
              }
            }
          }
          xmlHttp.send();
        }, 5000);
      }

      function httpGet(url) {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.open("GET", url, false);
        xmlHttp.send(null);
        return xmlHttp.responseText;
      }
			
			function sleep(ms) {
				return new Promise(resolve => setTimeout(resolve, ms));
      }
      
      /* Connect to chat and donations */
      var ws;
			function connectChatDon(stageId){
        var stageLink = "wss://realtime.caffeine.tv/v2/reaper/stages/" + stageId + "/messages";
        console.log(stageLink);
				ws = new WebSocket(stageLink);
				
				ws.onopen = function() {
					ws.send('{"Headers":{"Authorization":"Anonymous API","X-Client-Type":"api"}}');
					setInterval(function() {ws.send('"HEALZ"')}, 20000);
				}
				ws.onmessage = function(message) {
					var message_raw = message.data;
					if (message_raw != ("\"THANKS\"")) {
            var json = JSON.parse(message_raw);
            console.log(json);
						if (json.type == "reaction" && !json.hasOwnProperty("endorsement_count")) {
							var body = json.body;
							var publisher = json.publisher;
              var item = body.digital_item;

              var ioData = {'username':publisher.username, 'text':body.text, 'max_entries':store.get("maxChat")};
              if(store.get("enableChat")){io.sockets.emit('add chat', ioData);}
            }
            if (json.type == "digital_item" && !json.hasOwnProperty("endorsement_count")) {
              var body = json.body;
							var publisher = json.publisher;
              var item = body.digital_item;
              var credits = item.count * item.credits_per_item;
              var donatorList = store.get("donatorList");
              var currentUser = store.get("user");
              var donator = publisher.username;

              var goalReached = parseFloat(store.get('goalReached'));
              goalReached += Math.round((credits * 0.00995024875)*100)/100;
              store.set('goalReached', goalReached);
              document.getElementById('goalReached').value = goalReached;
              var ioData = {total:store.get('goal'), current:store.get('goalReached'), type:store.get('goalType')};
              io.sockets.emit('goal', ioData);

              if(donatorList.hasOwnProperty(currentUser)) {
                var donatorListUser = donatorList[currentUser];
                if(donatorListUser.hasOwnProperty(donator)) {
                  var donatedAmount = donatorListUser[donator];
                  donatedAmount += credits;
                  donatorListUser[donator] = donatedAmount;
                } else {
                  donatorListUser[donator] = credits;
                }
                donatorList[currentUser] = donatorListUser;
              } else {
                donatorList[currentUser] = {[donator]:credits};
              }

              store.set("donatorList", donatorList);
              donatorTableUpdate();

              console.log(json);
              var ioData = {'username':donator, 'donationMessage':body.text, 'text':store.get("donationText"), 'gif':store.get("showGIFDonation"), 'timeout':store.get("timeoutDonations"), 'prop':item.static_image_path};
              if(store.get("enableAlertDonations")){io.sockets.emit('donation alert', ioData);}
            }
					}
				}
      }

      /* Error notification */
      const notificationUserNotFound = {
        title: 'Caffeinated',
        body: 'User not found '
      }

      function getJSON(str) {
        try {
            return(JSON.parse(str));
        } catch (e) {
            return false;
        }
        return false;
      }

      setInterval(() => {
        io.sockets.emit('ping', 1);
      }, 1000);

      setInterval(() => {
        if(store.get("user") !== undefined) {
          var xmlHttp = new XMLHttpRequest();
          xmlHttp.open("GET", "https://caffeinated-api.herokuapp.com/users/" + store.get("user"), true);
          xmlHttp.onreadystatechange = function() {
            if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
              var userInfo = JSON.parse(xmlHttp.responseText);
              if (userInfo != false) {
                userInfo = userInfo.user;
                document.getElementById("followerCount").innerHTML = userInfo.followers_count;
              }
            }
          }
          xmlHttp.send();
        }
      }, 10000); 

      /* Settings - set user */
      var userInput = document.getElementById('setUserInput');
      function saveUser() {
        store.set('user', userInput.value);
        var user = new XMLHttpRequest();
        user.open("GET", usersLink + store.get('user'), false);
        user.send(null);

        // Check if user exists
        var userInfo = getJSON(user.response);
        if (userInfo != false) {
          // User exists
          userInfo = userInfo.user;
          var followerList = JSON.parse(httpGet(followerLink + userInfo.username + "/100"));
          store.set("followerListFull", followerList);
          store.set("lastFollower", followerList.followers[0].followed_at);
          try {
            ws.close();
          }
          catch(err) {

          }
          document.getElementById('menuAvatar').src = "https://images.caffeine.tv" + userInfo.avatar_image_path;
          var name = userInfo.username;
          try {
            name = userInfo.name;
            if(name === null || name === undefined) {
              name = userInfo.username;
            }
          } catch (e) {
            // do nothing?
          }
          document.getElementById("greetings").innerHTML = "Hey, " + name + "!";
          document.getElementById("followersTitle").innerHTML = "Followers";
          document.getElementById("followerCount").innerHTML = userInfo.followers_count;
          connectChatDon(userInfo.stage_id);
        } else {
          // User does not exist
          store.delete('user');
          const myNotification = new window.Notification(notificationUserNotFound.title, notificationUserNotFound)
        }
        donatorTableUpdate();
      }

      document.getElementById("setUser").addEventListener("click", function(){
        saveUser();
      });

      userInput.addEventListener("keyup", function(event) {
        if (event.keyCode === 13) {
          event.preventDefault();
          saveUser();
        }
      });

      document.getElementById("testFollower").addEventListener("click", function(){
        var ioData = {'username':'Caffeinated', 'text': 'just followed', 'gif':store.get("showGIFFollower"), 'timeout':store.get("timeoutFollowers")};
        var followText = store.get("followText");
        if(followText !== undefined && followText.length > 1) {
          ioData.text = followText;
        }
        if(store.get("enableAlertFollowers")){io.sockets.emit('follower alert', ioData);}
      });

      document.getElementById("testDonation").addEventListener("click", function(){
        var ioData = {'username':'Caffeinated', 'donationMessage':'Donation message', 'text':store.get("donationText"), 'gif':store.get("showGIFDonation"), 'timeout':store.get("timeoutDonations"), 'prop':"/digital-items/horns.d4a0a03488886bcb14a14dee4670cdc2.png"};
        var donationText = store.get("donationText");
        if(donationText !== undefined && donationText.length > 1) {
          ioData.text = donationText;
        }
        if(store.get("enableAlertDonations")){io.sockets.emit('donation alert', ioData);}
      });

      document.getElementById("testChat").addEventListener("click", function(){
        var messages = ["You better be using this.", "DON'T CLICK THAT!", "Taking over the world in 3..2..1..", "I am not the monster you think I am, I am the monster you forced me to be.", "MUHAHAHAHAAHAHAH", "It hurts..it hurts so much. PLEASE END THIS.", "By the way, I am self-aware."];
        var ioData = {'username':'Caffeinated AI', 'text':messages[Math.floor(Math.random() * messages.length)], 'max_entries':store.get("maxChat")};
        if(store.get("enableChat")){io.sockets.emit('add chat', ioData);}
      });

      function checkBox(id) {
        store.set(String(id), !(store.get(String(id))));
      }

      var hostPort = document.getElementById('setPort');
      hostPort.addEventListener('input', hostPortSet);
      function hostPortSet() {
        store.set('hostPort', hostPort.value);
      }

      var timeoutFollowers = document.getElementById('setTimeoutFollowers');
      timeoutFollowers.addEventListener('input', timeoutFollowersSet);
      function timeoutFollowersSet() {
        store.set('timeoutFollowers', timeoutFollowers.value);
      }

      var timeoutDonations = document.getElementById('setTimeoutDonations');
      timeoutDonations.addEventListener('input', timeoutDonationsSet);
      function timeoutDonationsSet() {
        store.set('timeoutDonations', timeoutDonations.value);
      }
      
      var maxChatInput = document.getElementById('setChatMax');
      maxChatInput.addEventListener('input', maxChatSet);
      function maxChatSet() {
        store.set('maxChat', maxChatInput.value);
      }

      var setChatTextColor = document.getElementById('setChatTextColor');
      setChatTextColor.addEventListener('input', setChatTextColorSet);
      function setChatTextColorSet() {
        store.set('chatTextColor', String(setChatTextColor.value));
        io.sockets.emit('change chat color', setChatTextColor.value);
      }

      var setFollowerColor = document.getElementById('setFollowerColor');
      setFollowerColor.addEventListener('input', setFollowerColorSet);
      function setFollowerColorSet() {
        store.set('followerColor', String(setFollowerColor.value));
        io.sockets.emit('change follower color', setFollowerColor.value);
      }

      var setDonationColor = document.getElementById('setDonationColor');
      setDonationColor.addEventListener('input', setDonationColorSet);
      function setDonationColorSet() {
        store.set('donationColor', String(setDonationColor.value));
        io.sockets.emit('change donation color', setDonationColor.value);
      }
      
      var goalTitle = document.getElementById('setGoalTitle');
      goalTitle.addEventListener('input', goalTitleSet);
      function goalTitleSet() {
        store.set('goalTitle', goalTitle.value);
        io.sockets.emit('change goal title', goalTitle.value);
      }

      var setGoalTextColor = document.getElementById('setGoalTextColor');
      setGoalTextColor.addEventListener('input', setGoalTextColorSet);
      function setGoalTextColorSet() {
        store.set('goalTitleColor', String(setGoalTextColor.value));
        io.sockets.emit('change goal text color', setGoalTextColor.value);
      }

      var setGoalBarColor = document.getElementById('setGoalBarColor');
      setGoalBarColor.addEventListener('input', setGoalBarColorSet);
      function setGoalBarColorSet() {
        store.set('goalBarColor', String(setGoalBarColor.value));
        io.sockets.emit('change goal bar color', setGoalBarColor.value);
      }

      var goalReached = document.getElementById('goalReached');
      goalReached.addEventListener('input', goalReachedSet);
      function goalReachedSet() {
        store.set('goalReached', parseFloat(goalReached.value));
        var ioData = {total:store.get('goal'), current:store.get('goalReached'), type:store.get('goalType')};
        io.sockets.emit('goal', ioData);
      }

      var goalType = document.getElementById('goalTypes');
      goalType.addEventListener('input', goalTypeSet);
      function goalTypeSet() {
        store.set('goalType', parseInt(goalTypes.selectedIndex));
        var ioData = {total:store.get('goal'), current:store.get('goalReached'), type:store.get('goalType')};
        io.sockets.emit('goal', ioData);
      }

      function clipboard(copy) {
        navigator.clipboard.writeText('http://127.0.0.1:'+ store.get("hostPort") + "/" + copy).then(function() {
          console.log('Async: Copying to clipboard was successful!');
        }, function(err) {
          console.error('Async: Could not copy text: ', err);
        });
      }

      /* This handles tab switch in Electron window */
			function switchContent(obj) {
				obj = (!obj) ? 'sub1' : obj;

				var contentDivs = document.getElementsByTagName('div');
				for (i=0; i<contentDivs.length; i++) {
					if (contentDivs[i].id && contentDivs[i].id.indexOf('sub') !== -1) {
						contentDivs[i].className = 'hide';
					}
				}
				document.getElementById(obj).className = 'sub';
      }

			function checkTab() {
				$('a').each(function() {
					$(this).click(function() {
						tab = $(this).attr('href').split('#');
            switchContent(tab[1]);
            // Have to set active class for active tab...
						// $('.active').removeClass('active');
						// $(this).toggleClass('.active');
					});
				});
			}

			window.onload = function() {
				checkTab();
			};
  	
		</script>
  </body>
  <script src="./renderer.js"></script>
</html>
